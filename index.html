<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QA Scoreboard</title>

  <!-- Premium serif for print -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link
  href="https://fonts.googleapis.com/css2?family=Rock+Salt&display=swap"
  rel="stylesheet"
/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    /* ===== SCREEN STYLES ===== */
    body { background: #121212; color: #eee; font-family: Arial, sans-serif; margin:0; padding:20px; }
    .container { max-width:1100px; margin:auto; background:#1a1a1a; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.6); padding:24px; }

    /* header */
    .brand-row { position: relative; display:flex; align-items:center; justify-content:space-between; margin-bottom:50px; }
    .brand-row .logo { height:50px; margin-top: 30px;}
    .brand-row .vegas-logo { position:absolute; left:50%; transform:translateX(-50%); height:150px; }
    .brand-row .top-right { display:flex; flex-direction:column; align-items:flex-end; gap:12px; }
    .brand-row .top1-name { font-size:30px; font-weight:700; color:#fff; margin-top: 30px;}
    .brand-row .top1-avatar { width:92px; height:92px; border-radius:50%; overflow:hidden; border:2px solid #fff; box-shadow:0 2px 8px rgba(0,0,0,0.7); }


.header-row {
  position: relative;       /* establish a positioning context */
  height: 4rem;             /* or whatever bit of vertical space you want */
  margin-bottom: 30px;      /* your existing spacing */
}


.header-row h1 {
  display: inline-flex;       /* → make the h1 an inline flex container */
  align-items: center;        /* → vertically centre all children */
  justify-content: center;    /* → keep the group centred in its parent */
  gap: 1.2rem;                /* → space between switcher, month and “, scoreboard” */
  font-size: 1.5rem;          /* (or whatever you already had) */
  margin: 0;                  /* remove extra margins */
}
    
    
    
    
    
#current-month {
  position: absolute;
  top: 0;
  right: 0;
  transform: translateY(-50%);
  font-size: 25px;           /* your existing size */
  font-weight: 700;          /* your existing weight */
  text-transform: uppercase; /* your existing transform */
  margin: 0;                 /* reset any stray margins */
}

    .tools { position:sticky; top:0; background:#1a1a1a; padding:12px 0; display:flex; justify-content:space-between; align-items:center; z-index:10; margin-bottom:24px; }
    .months { display:flex; gap:8px; flex-wrap:wrap; }
    .month-btn, .print-btn, .file-btn, .compare-btn {
      background:#272727; color:#ccc; border:none; border-radius:6px;
      cursor:pointer; transition:0.2s; font-size:0.95rem;
      padding:18px 25px; display:flex; align-items:center; margin-left:7px;
    }
    .compare-btn { display:none; }
    .month-btn:hover, .print-btn:hover, .file-btn:hover, .compare-btn:hover,
    .month-btn:focus, .print-btn:focus, .file-btn:focus, .compare-btn:focus {
      background:#333; color:#fff; box-shadow:0 2px 12px rgba(0,0,0,0.8);
      outline:none; transform:translateY(-2px);
    }
    .month-btn.active {
      background:linear-gradient(135deg,#4a90e2,#9013fe);
      color:#fff; transform:scale(1.2); box-shadow:0 4px 16px rgba(0,0,0,0.7);
    }
    
    .print-btn
   {
   	transform:scale(1);
    }

.print-btn:hover
   {
   	transform:scale(2);
    }
    
.detail-print-btn:hover
   {
   	transform:scale(2);
    }

    table { width:100%; border-collapse:collapse; margin-bottom:24px; }
    thead th { background:#272727; padding:12px; text-align:left; }
    th[data-key] { cursor:pointer; }
    th, td { padding:12px; border-bottom:1px solid #333; }
    tbody tr { transition:background 0.2s; cursor:pointer; }
    tbody tr:hover { background:#2a2a2a; }
    .profile-img { width:32px; height:32px; border-radius:50%; margin-right:8px; vertical-align:middle; }
    tbody tr.top3 { font-size:1.2em; background:linear-gradient(90deg,rgba(74,144,226,0.1),transparent); }
    tbody tr.top3 .profile-img { width:48px; height:48px; }
    
    table tbody td:nth-child(2),
table tbody td:nth-child(3),
table tbody td:nth-child(4),
table tbody td:nth-child(5),
table tbody td:nth-child(6) {
  text-align: center;
}


/* ≈ height of the toolbar → adjust if you change its padding */
:root{ --toolbar-h: 84px; }   /* one place to tune the gap */

/* make the whole header group sticky */
table thead{
  position: sticky;
  top: var(--toolbar-h);   /* parks it right under the months bar  */
  z-index: 5;             /* just below the toolbar, above rows   */
}

/* give it a solid background so rows don’t shine through when it hovers */
table thead th{
  background:#272727;      /* same colour you already use */
}

    /* detail row */
    .detail-row td { padding:0; border:0; }
    .details-container { height:0; overflow:hidden; transition:height 0.3s ease; padding:0 12px; }
    .detail-row.visible .details-container { padding:16px 12px; }

    .detail-charts { display:flex; flex-wrap:wrap; gap:16px; justify-content:space-around; }
    .chart-wrapper { text-align:center; font-size:0.9rem; }
    .chart-wrapper canvas {
  border: 2px solid #fff;
  border-radius: 50%;
}

    /* shared notes/PTO/sick area */
    .notes-menu { display:flex; gap:12px; flex-wrap:wrap; margin-top:16px; }
    .note-toggle {
      flex:1; padding:8px; border:none; border-radius:6px;
      color:#fff; cursor:pointer; transition:transform 0.2s; font-size:0.9rem;
      background:#4a90e2;
    }
    .note-toggle.has-note { background:#ff8c00; }
    .note-toggle.active { transform:scale(1); }
    /* fixed 150px tall, with a border when open */
    
    
    /* detail header with print button */
    .details-header { position:relative; margin-bottom:12px; }
    .details-header h3 { margin:0; }
    .detail-print-btn {
      position:absolute; top:0; right:0;
      background: #5f5f73;
      border:none; color:#fff; padding:6px 12px; border-radius:6px;
      cursor:pointer; transition:0.2s;
      margin-right: 15px;
    }
    .detail-print-btn:hover { opacity:0.9; }
    
    

/* your wrapper that actually pushes/pulls the rows */
.details-container {
  overflow: hidden;
  transition: height 0.3s ease;
  margin-top: 15px;
}

/* optional—give the charts their own top gap */
.detail-charts {
  margin-top: 30px;      /* new */
}



.notes-detail-container {
  visibility: hidden;
  box-sizing: border-box;
  padding: 0 12px;
  /* REMOVE the permanent 12px top-margin */
  margin-top: 0;
  border: 2px solid transparent;
  border-radius: 4px;
  transition: padding 0.3s ease, border-color 0.3s ease;
}

.notes-detail-container.open {
visibility: visible;
  /* only when open do we get that 12px gap and padding */
  margin-top: 12px;
  padding: 12px;
  min-height: 150px;
}

/* give each toggle button a custom property for its “highlight” colour */
.note-toggle {
  --toggle-border-color: #4a90e2;   /* default “blue” */
  transition: transform 0.2s ease;
}

/* override for any button that has-note (i.e. your orange ones) */
.note-toggle.has-note {
  --toggle-border-color: #ff8c00;
}

/* when active, scale up and draw a 2px border in the button’s colour */
.note-toggle.active {
  transform: scale(1.1);
  border: 2px solid var(--toggle-border-color);
  box-shadow: 0 0 0 2px #fff;
}



    /* compare section & close */
    #compare-container { position:relative; display:none; margin-top:24px; margin-left:14px; }
    #close-compare {
      position:absolute; top:8px; right:8px; z-index:10;
      background:none; border:none; color:#ccc; font-size:1.2rem; cursor:pointer; transition:0.2s;
    }
    #close-compare:hover { color:#fff; }


/* 1) GRID FOR THE THREE COLUMNS */
#compare-rows{
  display:grid;
  grid-template-columns:minmax(0,1fr)   /* left column  */
                       auto              /* centre label */
                       minmax(0,1fr);    /* right column */
  column-gap:24px;
  row-gap:44px;
  align-items:center;
  margin-top:20px;
  
}

/* 2) BASIC CELL STYLING */
.cmp-cell{
  display:flex;
  flex-direction:column;
  width:100%;          /* <-- add this */
  gap:4px;
}
.cmp-cell.left  { align-items: flex-start; }
.cmp-cell.center { text-align: center; color: #ccc; }
.cmp-cell.right { align-items: flex-end; }

/* 3) BAR + OVERLAYED VALUE */
.cmp-bar-container{
  position:relative;
  width:100%;          /* <- this is the new line */
  height:24px;
  margin:8px 0;        /* keep the 8 px top/bottom gap */
}
.cmp-bar {
  position: absolute;
  left:   0; right: 0; bottom: 0;
  height: 8px;
  background: #333;
  border: 1px solid #fff;
  border-radius: 4px;
  overflow: hidden;
}
.cmp-bar .fill {
  height: 100%;
  background: currentColor; /* picks up .winner/.loser colour */
  transition: width .4s ease;
}
.cmp-value{
  position:absolute;
  top:-2px;                 /* just above the bar */
  white-space:nowrap;
  font-size:1.6rem;
  font-weight:900;
}
/* make the right-hand bar grow from the right edge */
.cmp-cell.right .cmp-bar .fill{
  left:0;               /* cancel the default “left:0” */
  right:auto;
}

/* make the right-hand bar grow from the right edge */
.cmp-cell.left .cmp-bar .fill{
  left: auto !important;
  right: 0     !important;
}

/* anchor the number to the bar-end and flip its translate */
.cmp-cell.left .cmp-value{
  left:100%;                               /* park origin at right edge  */
  transform:translateX(calc(-100% - 15px)); /* …then pull text back in */
} /* unchanged */
.cmp-cell.right .cmp-value{
  right:100%;                              /* park origin at left edge   */
  transform:translateX(calc( 100% + 15px));
}

.cmp-cell.left  .cmp-value{ margin-left:6px;  }
.cmp-cell.right .cmp-value{ margin-right:6px; }

/* 4) WINNER / LOSER COLOURS */
.cmp-cell.winner { color: #2738f2; }
.cmp-cell.loser  { color: #f0cf99; }

/* 5) NAME + RANK TEXT */
.cmp-name { font-size: 1.4rem; font-weight: 700; }
.cmp-rank { font-size: 0.9rem; color: currentColor; }





/* 6) “X” CLOSE BUTTON (just in case) */


.compare-toggle {
  background-color: #000;        /* solid black */
  color: #fff;                   /* white text */
  border: none;                  
  border-radius: 20px;           /* nice pill shape */
  padding: 8px 16px;             /* space around the label */
  font-size: 0.9rem;             
  font-weight: 600;              /* a bit bolder */
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  transition: background-color 0.2s ease, transform 0.1s ease;
}

.compare-toggle:hover {
  background-color: #222;        /* dark gray on hover */
}

.compare-toggle:active {
  transform: scale(0.97);        /* subtle press effect */
}

/* big bold rank badge in place of an image */
.rank-label {
  display: inline-block;
  font-size: 1.4rem;
  font-weight: 700;
  color: #fff;         /* or whatever highlight colour you like */
  margin-right: 12px;
  width: 48px;            /* match your old avatar size for alignment */
  text-align: center;
}



/* hide until a chart is active */
.history-container { display: none; }

/* only show once JS adds “.visible” */
.history-container.visible {
  display: flex;
  justify-content: space-between;    /* stretch pills across full width */
  font-family: 'Montserrat', sans-serif;
  font-weight: 500;
  font-size: 0.7rem;                 /* a bit larger & more legible */
  width: 100%;
  margin-top: 16px;
}

/* each month/value pair */
.history-item {
  flex: 1 1 0;
  text-align: center;
  padding: 6px 4px;
  border-radius: 4px;

  /* light gray pill background */


  /* dark text by default */
  color: #fff;
  font-size: 0.8rem;
  font-family: 'Montserrat', sans-serif;
  font-weight: 500;
}

/* best month → dark green text */
.history-item.best {
  color: #99f0bf;
}

/* worst month → dark red text */
.history-item.worst {
  color: #f28f8f;
}

/* highlight current month in blue */
.history-item.current {
  background: #4a90e2;
}


#compare-container {
  position: relative;        /* allow the close button to be positioned inside */
  display: none;
  margin-top: 50px;
  margin-left: 14px;
  --rail: 40px;
}

#close-compare{
  position:absolute;          /* already set */
  right:8px;                  /* already set  */
  top:-44px;                  /* ⬅ raise it ± 1.5 rem (tweak to taste) */

  /* optional: if you animated the size on hover */
  transition:transform .15s;
}
#close-compare:hover{
  transform:scale(2);
  color:#fff;
}


.compare-header,
#compare-rows{
  padding-inline: var(--rail);          /* ← left & right padding */
}


/* make any active chart 1.2× */
.chart-wrapper {
  transition: transform 0.2s ease;
  cursor: pointer;
}
.chart-wrapper.active {
  transform: scale(1.2);
  z-index: 1;
}


.cmp-bar-container {
  position: relative;
  width: 100%;
  height: 24px;       /* room for the number above */
  margin: 0 auto;     /* center the whole thing if you like */
}

.cmp-bar {
  position: absolute;
  bottom: 0;
  left:   0;
  right:  0;
  height: 8px;
  background: #333;
  border: 1px solid #fff;
  border-radius: 4px;
  overflow: hidden;
  margin-top: 50px;
}

.cmp-bar .fill {
  height: 100%;
  background: currentColor;  /* picks up winner/loser color */
  transition: width 0.4s ease;
    position: absolute;
  top:    0;
  bottom: 0;
  left:   0;    /* default: grow from left edge */
  width:  auto; /* will be set via inline style="width:NN%" */
}

.cmp-value {
  position: absolute;
  top: 0;
  margin-top: 30px;
  /* shift the number so its center sits right on the fill’s end */
  transform: translateX(-50%);
  /* we’ll override left/right in JS via style="" */
  white-space: nowrap;
  font-size: 1.8rem;
  font-weight: 700;
}

.cmp-value.left{
  margin-right: 15px;
}

.cmp-value.right{
  margin-left: 15px;
}

#compare-rows > div{
  display: contents;
}

/* 1) make both employees’ names and the big value numbers pure white */
.cmp-name,
.cmp-value{
  color:#fff !important;          /* override the blue / orange        */
}

/* 2) category label (middle column) → bold white                      */
.cmp-cell.center{
  color:#fff;
  font-weight:700;
}

/* 3) winner = 150 % size bump                                         */
.cmp-cell.winner .cmp-name{
font-size:150%;
  
  opacity:0.8;
}

/* 4) loser = 60 % opacity                                             */
.cmp-cell.loser  .cmp-name,
.cmp-cell.loser  .cmp-value{
  opacity:0.4;
  font-size:150%;
}

/* ───────────────── HEADER ───────────────── */
/* ───── centred “name  VS  name” badge ───── */
.compare-header{
  display:grid;
  /*   left name   │   VS   │   right name   */
  grid-template-columns: 1fr auto 1fr;
  align-items:center;

  /* 50 px breathing-room from the container edges */


  /* spacing underneath the badge */
  margin-bottom:35px;

  font:700 1.9rem "Montserrat",sans-serif;
  color:#fff;
}

/* centre “VS” in the middle column */
.compare-header .vs{
  justify-self:center;
  opacity:.85;
  font-size: 1rem;
}

/* left & right names hug their respective sides */
#cmp-left  { justify-self:end; margin-right: 70px;}
#cmp-right { justify-self:start;   margin-left: 70px;}

/* keep the names on one line */
.cmp-name-big{
  white-space:nowrap;
  font-size: 2.5rem;
}


/* ───────────  stop the bar-row names competing with the header ─────── */
.cmp-cell .cmp-name{               /* the small names under each bar    */
  font-size:1.1rem;                /* shrink a bit                      */
  opacity:.65;                     /* and fade                          */
}

/* the grid of bars must now start *flush* under the header */
#compare-rows{ margin-top:0; }





.text-button {
  background: none;
  border: none;
  padding: 0;
  margin: 0;
  font-family: 'Rock Salt', cursive;
  color: inherit;      /* same color */
  line-height: inherit;
  cursor: pointer;
  margin-right: 20px;
  font-size: 1.8rem;
  overflow: visible;
  position: relative;
  
}
.text-button::after {
  content: "";
  position: absolute;
  bottom: -4px;                 /* tweak vertical gap to taste */
  left: 40%;
  width: 0;
  height: 2px;                  /* underline thickness */
  background: #ffffffaa;        /* semi-opaque white */
  transition: width 0.3s ease, left 0.3s ease;
  box-shadow:
    0  2px 6px rgba(0,0,0,0.8),   /* below */
}


.text-button:hover::after {
  left: 0;
  width: 100%;

}

.text-button:hover{
  color: #efd9fa;
}


.site-switcher {
  position: absolute;
  top: 50%;
  left: 51%;
  transform: translate(-50%, -51%);
}

/* hidden by default */
.site-switcher-item {
  position: absolute;
  left: 0;
  top: 0;
  opacity: 0;
  pointer-events: none;
  transition: transform 0.3s ease, opacity 0.3s ease;
}

/* when open → slide one up, one down */
.site-switcher.open .site-switcher-item:nth-of-type(2) {
  opacity: 1;
  pointer-events: auto;
  transform: translateX(-12.5rem);
}
.site-switcher.open .site-switcher-item:nth-of-type(3) {
  opacity: 1;
  pointer-events: auto;
  transform: translateX(12.5rem);
}

/* LOGIN OVERLAY */
#login-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.95);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
#login-overlay .login-box {
  background: #1a1a1a;
  padding: 40px;
  border-radius: 8px;
  text-align: center;
  box-shadow: 0 8px 24px rgba(0,0,0,0.8);
  max-width: 360px;
  width: 100%;
}
#login-overlay .login-logo,
#login-overlay .login-vegas {
  height: 60px;
  margin-bottom: 35px;
  vertical-align: middle;
}
#login-overlay h1 {
  font-family: 'Playfair Display', serif;
  font-size: 1.8rem;
  color: #eee;
  margin: 16px 0 4px;
}
#login-overlay p {
  font-family: 'Montserrat', sans-serif;
  color: #aaa;
  margin-bottom: 24px;
  font-size: 1.2rem;
}
#login-overlay form input {
  width: 100%;
  padding: 12px;
  margin-bottom: 16px;
  border: 1px solid #333;
  border-radius: 4px;
  background: #121212;
  color: #eee;
  font-size: 1rem;
}
#login-overlay form button {
  width: 107%;
  padding: 12px;
  border: none;
  border-radius: 6px;
  background: linear-gradient(135deg,#4a90e2,#9013fe);
  color: #fff;
  font-size: 1.1rem;
  cursor: pointer;
  transition: transform .15s, box-shadow .15s;
}
#login-overlay form button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(0,0,0,0.7);
}


/* blur the page until login succeeds */
#scoreboard-container.blurred {
  filter: blur(6px);
  transition: filter .3s ease;
}
/* error message under the login form */
#login-error {
  color: #ff8c00;
  font-size: 0.9rem;
  min-height: 1.2em;
  margin-bottom: 12px;
}


        /* optional -- center text on narrow screens */
@media(max-width:600px){
  .compare-header{
    flex-direction:column;
    gap:8px;
  }
}


    @media print {
      .compare-toggle, .tools, .detail-row, #close-compare, #compare-container { display:none !important; }
      body, .container { background:#fff !important; color:#000 !important; }
    }
  </style>
</head>
<body>


  <!-- LOGIN OVERLAY -->
  <div id="login-overlay">
    <div class="login-box">
      <img src="logo.png" class="login-logo" alt="Hilton Logo">
      <img src="vegas.png" class="login-vegas" alt="Vegas Logo">

      <form id="login-form">
        <div id="login-error" class="login-error"></div>
        <input type="text"     id="login-user"   placeholder="Username" required>
        <input type="password" id="login-pass"   placeholder="Password" required>
        <button type="submit">Log in</button>
      </form>
    </div>
  </div>

<div class="container blurred" id="scoreboard-container">
    <div class="brand-row">
      <img src="logo.png" class="logo" alt="Hilton Logo">
      <img src="vegas.png" class="vegas-logo" alt="Vegas Logo">
      <div class="top-right">
        <div class="top1-name" id="top-overall">#1: —</div>
      </div>
    </div>

<div class="header-row">
  <!-- 1) your site-switcher -->
  <span class="site-switcher">
    <button class="text-button active" id="site-btn-main">Elara</button>
    <button class="text-button site-switcher-item">LVB</button>
    <button class="text-button site-switcher-item">Cancun</button>
  </span>

  <!-- 2) your month -->
  <span id="current-month">MAY</span>
</div>

    <div class="tools">
      <div class="months" id="months-container"></div>
      <button class="compare-btn" id="compare-btn">🔍 Compare Selected</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>HGV QA</th>
          <th data-key="overall">Score</th>
          <th data-key="accuracy">Accuracy %</th>
          <th data-key="rescission">Rescission %</th>
          <th data-key="transactions">Transactions</th>
          <th data-key="issues">Open Issues</th>
          <th id="uploadth">
            <button class="file-btn" id="file-btn">📁</button>
            <input type="file" id="file-input" accept=".xlsx" style="display:none">
          </th>
          <th>
            <button class="print-btn" id="print-btn" style="display:none;">🖨️</button>
          </th>
        </tr>
      </thead>
      <tbody id="scoreboard-body"></tbody>
    </table>

<div id="compare-container">
  <button id="close-compare" aria-label="Close comparison">✖</button>

  <!-- header (names + VS) -->
  <div class="compare-header">
    <span id="cmp-left"  class="cmp-name-big"></span>
    <span class="vs">VS</span>
    <span id="cmp-right" class="cmp-name-big"></span>
  </div>

  <div id="compare-rows"></div>
</div>
</div>
</div>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable"></script>
  <script>
    let howManyCompareSelected = 0;
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    let currentMonth = "May";
    let siteSelected = "Elara";
    const scoreboardData = {}, sortConfig = { column:'overall', direction:'desc' }, compareSelection = new Set();

    const fullMonthNames = {
  Jan: "January",
  Feb: "February",
  Mar: "March",
  Apr: "April",
  May: "May",
  Jun: "June",
  Jul: "July",
  Aug: "August",
  Sep: "September",
  Oct: "October",
  Nov: "November",
  Dec: "December",
};
  
function loadSiteFile(site) {
  // 1) clear out old data
  for (let month of months) {
    delete scoreboardData[month];
  }
  // 2) re-parse the new file
  fetch(site + '.xlsx')
    .then(r => {
      if (!r.ok) throw new Error(`Couldn't load ${site}.xlsx`);
      return r.arrayBuffer();
    })
    .then(parseWorkbook)
    .catch(err => console.error(err));
}      
      
  
document.addEventListener("DOMContentLoaded", () => {
  loadSiteFile(siteSelected);
  initUI();
     
    
});
      


    function initUI(){
      const mc = document.getElementById("months-container");
      months.forEach(m=>{
        const b=document.createElement("button");
        b.className="month-btn"; b.textContent=m; b.dataset.month=m;
        b.onclick=()=>selectMonth(m,b);
        mc.appendChild(b);
      });

      document.getElementById("file-btn").onclick    = ()=>document.getElementById("file-input").click();
      document.getElementById("compare-btn").onclick = showComparison;
      document.getElementById("print-btn").onclick   = downloadReport;
      document.getElementById("file-input").onchange = e=>{
        const f=e.target.files[0]; if(!f) return;
        const r=new FileReader(); r.onload=ev=>parseWorkbook(ev.target.result);
        r.readAsArrayBuffer(f);
      };

      document.querySelectorAll('thead th[data-key]').forEach(th=>{
        th.onclick=()=>{
          const key=th.dataset.key;
          if(sortConfig.column===key) sortConfig.direction = sortConfig.direction==='asc'?'desc':'asc';
          else { sortConfig.column=key; sortConfig.direction='asc'; }
          renderTable(currentMonth);
        };
      });

      selectMonth(currentMonth, document.querySelector(`.month-btn[data-month="${currentMonth}"]`));
      
      
      document.getElementById('close-compare').addEventListener('click', () => {
  // hide the comparison panel
  document.getElementById('compare-container').style.display = 'none';
  // scroll back up to the top of the scoreboard
  document.getElementById('scoreboard-container')
          .scrollIntoView({ behavior: 'smooth' });
});
      
      
    }


    function parseWorkbook(ab){
      const wb=XLSX.read(ab,{type:"array"});
      wb.SheetNames.forEach(sheet=>{
        if(!months.includes(sheet)) return;
        const raw = XLSX.utils.sheet_to_json(wb.Sheets[sheet],{defval:""});
        scoreboardData[sheet] = raw.map(r=>({
          name:       r["Quality Assurance"]||"N/A",
          accuracy:   Number(r["Accuracy"])||0,
          rescission: Number(r["Rescission"])||0,
          transactions:Number(r["Transactions"])||0,
          issues:     Number(r["Open Issues"])||0,
          overall:    Number(r["Overall"])||0,

          accuracyTarget:    Number(r["Accuracy Target"])   ||100,
          rescissionTarget:  Number(r["Rescission Target"]) ||100,
          transactionsTarget: Number(r["Transactions Target"]) || 0,
          issuesTarget:       raw.reduce((s,u)=>s + (Number(u["Open Issues"])||0),0),
          overallTarget:     Number(r["Overall Target"])    ||10,

          NTF:     r["NTF"]       ||"",
          Verbal:  r["Verbal"]    ||"",
          Written: r["Written"]   ||"",
          Final:   r["Final"]     ||"",
          PTO:     r["PTO"]       ||"",
          "Sick Time": r["Sick Time"]||"",

          img: `https://i.pravatar.cc/150?img=${1+Math.floor(Math.random()*70)}`
        }));
      });

      document.getElementById("file-btn").style.display    ="none";
      document.getElementById("file-input").style.display ="none";
      document.getElementById("uploadth").style.display   ="none";
      document.getElementById("print-btn").style.display  ="block";

      selectMonth(currentMonth, document.querySelector(`.month-btn[data-month="${currentMonth}"]`));
    }

    function selectMonth(mon,btn){
      document.querySelectorAll(".month-btn.active").forEach(x=>x.classList.remove("active"));
      btn?.classList.add("active");
      currentMonth=mon;
      document.getElementById("current-month").textContent = fullMonthNames[mon].toUpperCase();
      renderTable(mon);
      updateTopOverall(mon);
      document.getElementById("compare-container").style.display='none';
      compareSelection.clear(); howManyCompareSelected=0;
    }

    function renderTable(mon){
      const tb=document.getElementById("scoreboard-body"); tb.innerHTML="";
      const colIdx={overall:1,accuracy:2,rescission:3,transactions:4,issues:5};
      const key=sortConfig.column, idx=colIdx[key], lowBetter=(key==="rescission"||key==="issues");
      (scoreboardData[mon]||[]).slice().sort((a,b)=>{
        return sortConfig.direction==='asc'? a[key]-b[key] : b[key]-a[key];
      }).forEach((r,i)=>{
        const suf=r.name.replace(/\W+/g,'-');
        const tr=document.createElement("tr");
        if(i<3) tr.classList.add("top3");
        tr.innerHTML=`
          <td><span class="rank-label">#${i+1}</span>${r.name}</td>
          <td>${r.overall}</td><td>${r.accuracy}%</td><td>${r.rescission}%</td>
          <td>${r.transactions}</td><td>${r.issues}</td>
          <td><button class="compare-toggle" data-name="${r.name}">Compare</button></td>`;
        const cells=tr.querySelectorAll("td");
        cells.forEach(td=>td.style.color="white");
        const met= lowBetter? r[key]<=r[key+"Target"] : r[key]>=r[key+"Target"];
        cells[idx].style.color= met? "#4a90e2":"#ff8c00";

        const detailTr=document.createElement("tr");
        detailTr.className="detail-row";
        detailTr.innerHTML=`
          <td colspan="7">
            <div class="details-container">
              <div class="details-header">
                <h3>Details for ${r.name}</h3>
                <button class="detail-print-btn">🖨️</button>
              </div>
              <div class="detail-charts">
                ${['overall','accuracy','rescission','transactions','issues'].map(k=>{
                  const lbl={overall:'Overall',accuracy:'Accuracy',rescission:'Rescission',transactions:'Transactions',issues:'Open Issues'}[k];
                  return `<div class="chart-wrapper">
                    <canvas id="chart-${suf}-${k}" width="120" height="120"></canvas>
                    <p>${lbl}</p>
                  </div>`;
                }).join('')}
              </div>
              <div class="history-container"></div>
              <div class="notes-menu">
                ${['NTF','Verbal','Written','Final','PTO','Sick Time'].map(field=>{
                  const has=(r[field]||"").trim()!=="";
                  return `<button class="note-toggle ${has?'has-note':'no-note'}" data-key="${field}">${field}</button>`;
                }).join('')}
              </div>
              
              <div class="notes-detail-container"></div>
            </div>
          </td>`;
        const container=detailTr.querySelector('.details-container');
        tr.addEventListener('click',()=>{
          if(detailTr.classList.contains('visible')){
            const h=container.scrollHeight; container.style.height=h+'px';
            requestAnimationFrame(()=>container.style.height='0');
            detailTr.classList.remove('visible');
          } else {
            detailTr.classList.add('visible');
            requestAnimationFrame(()=>container.style.height=container.scrollHeight+'px');
            drawDetailCharts(r);
            
            
            const historyCt = detailTr.querySelector('.history-container');
const chartWrappers = Array.from(detailTr.querySelectorAll('.chart-wrapper'));

// renderHistory: fills .history-container for a given metric
function renderHistory(row, metricKey) {
  const historyCt = detailTr.querySelector('.history-container');
  historyCt.innerHTML = '';

  // 1) Gather the 12 monthly values (null if missing/0)
  const values = months.map(m => {
    const rec = (scoreboardData[m]||[]).find(u=>u.name===row.name);
    return rec && rec[metricKey] != null && rec[metricKey] !== 0
      ? rec[metricKey]
      : null;
  });

  // 2) Filter to only the months with actual numbers
  const numeric = values.filter(v=>v != null);

  // 3) Decide if lower-is-better for this metric
  const lowBetter = (metricKey === 'rescission' || metricKey === 'issues');  // LOW-BETTER

  // 4) Compute best/worst according to that rule
  let best = null, worst = null;
  if (numeric.length) {
    if (lowBetter) {
      // for rescission & issues: best = min, worst = max
      best  = Math.min(...numeric);
      worst = Math.max(...numeric);
    } else {
      // for all others: best = max, worst = min
      best  = Math.max(...numeric);
      worst = Math.min(...numeric);
    }
    // if they’re all equal, we’ll just highlight “best”
    if (best === worst) worst = null;
  }

  // 5) Render each pill
  months.forEach((m,i) => {
    const v = values[i];
    const pill = document.createElement('div');
    pill.className = 'history-item';

    if (v == null) {
      pill.textContent = `${m}: N/A`;
    } else {
      const suf = /^(accuracy|rescission)$/.test(metricKey) ? '%' : '';
      pill.textContent = `${m}: ${v}${suf}`;

      if (v === best)      pill.classList.add('best');   // dark-green
      else if (v === worst) pill.classList.add('worst');  // dark-red
    }

    historyCt.appendChild(pill);
  });
}


// wire up click on each chart
chartWrappers.forEach(wrapper => {
  wrapper.addEventListener('click', () => {
    const historyCt = detailTr.querySelector('.history-container');

    // if clicking the *same* active chart, clear everything:
    if (wrapper.classList.contains('active')) {
      wrapper.classList.remove('active');
      historyCt.classList.remove('visible');
      historyCt.innerHTML = '';
      return;
    }

    // otherwise, clear old and mark this one active
    chartWrappers.forEach(w => w.classList.remove('active'));
    wrapper.classList.add('active');

    // compute & render new history…
    const canvas = wrapper.querySelector('canvas');
    const metric = canvas.id.split('-').pop();
    renderHistory(r, metric);

    // and show the strip
    historyCt.classList.add('visible');
  });
});
          }
        });

        // — NEW: individual print — 
        detailTr.querySelector('.detail-print-btn')
          .addEventListener('click', ev=>{
            ev.stopPropagation();
            printEmployee(r);
          });

// 1) grab the two elements we need
const detailContainer = detailTr.querySelector('.details-container');
const detailBox       = detailTr.querySelector('.notes-detail-container');
const toggles         = Array.from(detailTr.querySelectorAll('.note-toggle'));

// 2) internal state
let notesOpened = false;
let baseHeight  = 0;

toggles.forEach(btn => {
  btn.addEventListener('click', ev => {
    ev.stopPropagation();
    const isActive = btn.classList.contains('active');

    // ——— CASE A: clicking the same active button → collapse everything ———
    if (isActive) {
      btn.classList.remove('active');
      detailBox.classList.remove('open');
      detailBox.textContent = '';
      notesOpened = false;

      // animate panel back up
      requestAnimationFrame(() => {
        detailContainer.style.height = detailContainer.scrollHeight - baseHeight + 150 + 'px';
      });


      return;
    }

    // ——— CASE B: nothing’s open yet → first open, record height & expand ———
    if (!notesOpened) {
      baseHeight = detailContainer.scrollHeight;
      notesOpened = true;

      // activate this one
      btn.classList.add('active');
      detailBox.textContent = r[btn.dataset.key] || "";
      detailBox.style.borderColor =
        getComputedStyle(btn).getPropertyValue('--toggle-border-color').trim();
      detailBox.classList.add('open');

      // animate container down
      requestAnimationFrame(() => {
        detailContainer.style.height = detailContainer.scrollHeight + 'px';
      });

    // ——— CASE C: panel already open but different button → just swap content ———
    } else {
      // clear previous
      toggles.forEach(b => b.classList.remove('active'));

      // activate this one
      btn.classList.add('active');
      detailBox.textContent = r[btn.dataset.key] || "";
      detailBox.style.borderColor =
        getComputedStyle(btn).getPropertyValue('--toggle-border-color').trim();

      // **no height change here**, so the panel stays put
    }
  });
});

        // compare logic (unchanged)
        const cmp=tr.querySelector('.compare-toggle');
        cmp.addEventListener('click', ev=>{
          ev.stopPropagation();
          const name=cmp.dataset.name;
          if(cmp.textContent==='Compare'){
            howManyCompareSelected++; compareSelection.add(name);
            cmp.textContent='Remove'; cmp.classList.add('remove'); tr.style.opacity='0.5';
            if(howManyCompareSelected===2) setTimeout(showComparison,200);
          } else {
            howManyCompareSelected--; compareSelection.delete(name);
            cmp.textContent='Compare'; cmp.classList.remove('remove'); tr.style.opacity='1';
          }
        });

        tb.appendChild(tr);
        tb.appendChild(detailTr);
      });
    }

function updateTopOverall(mon){
  const arr = (scoreboardData[mon]||[]).sort((a,b)=>b.overall-a.overall);
  const top = arr[0]||{};
  document.getElementById("top-overall").textContent = `#1: ${top.name||'—'}`;

  // replace the image entirely with our text label
  const avatar = document.getElementById("top1-avatar");
  avatar.textContent = "Quality Assurance";
  avatar.style.fontSize   = "1.2rem";
  avatar.style.fontWeight = "700";
  avatar.style.color      = "#fff";
}

function drawDetailCharts(r) {
  const suf = r.name.replace(/\W+/g, '-');
  // metrics to draw
  const metrics = [
    { key: 'overall',      val: r.overall,      max: r.overallTarget      },
    { key: 'accuracy',     val: r.accuracy,     max: r.accuracyTarget     },
    { key: 'rescission',   val: r.rescission,   max: r.rescissionTarget   },
    { key: 'transactions', val: r.transactions, max: r.transactionsTarget },
    { key: 'issues',       val: r.issues,       max: r.issuesTarget       }
  ];

  metrics.forEach(m => {
    const chartId = `chart-${suf}-${m.key}`;
    const wrapper = document.getElementById(chartId).closest('.chart-wrapper');
    const labelEl = wrapper.querySelector('p');

    // decide if "lower is better"
    const lowBetter = (m.key === 'rescission' || m.key === 'issues');

    // build the two‐slice doughnut data & colors
    let data, bg;
    const meetsTarget = lowBetter
      ? (m.val <= m.max)
      : (m.val >= m.max);

    if (meetsTarget) {
      data = [ m.max, 0 ];
      bg   = [ '#4a90e2', '#333' ];
    } else {
      if (lowBetter) data = [ m.max, m.val - m.max ];
      else           data = [ m.val, m.max - m.val ];
      bg = [ '#4a90e2', '#ff8c00' ];
    }

    // ——— compute this person's rank in the current month ———
    const monthData = scoreboardData[currentMonth] || [];
    // sort ascending if lowBetter, descending otherwise
    const sorted = monthData.slice().sort((a, b) => {
      return lowBetter
        ? a[m.key] - b[m.key]
        : b[m.key] - a[m.key];
    });
    const idx  = sorted.findIndex(u => u.name === r.name);
    const rank = idx >= 0 ? idx + 1 : '–';
    
    const canvasEl = document.getElementById(chartId);

// Set its title (native tooltip) and a helpful cursor
canvasEl.title        = `Rank: #${rank}`;
canvasEl.style.cursor = 'context-menu';

    // ——— create the Chart.js chart with a hover tooltip ———
    const ctx = document.getElementById(chartId).getContext('2d');
    const chart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        datasets: [{
          data: data,
          backgroundColor: bg,
          hoverOffset: 6
        }]
      },
      options: {
        cutout: '70%',
        responsive: true,
        // show **only** our custom tooltip on hover
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            // style it to look “cool”
            backgroundColor: 'rgba(0,0,0,0.8)',
            titleFont:  { size: 0 },     // hide default title
            bodyFont:   { weight: 'bold', size: 12 },
            padding:     8,
            cornerRadius: 4,
            displayColors: false,
            callbacks: {
              // we ignore the slice index entirely and just show rank
              label: () => `Rank: #${rank}`
            }
          }
        },
        // ensure hover-events fire on the inner circle as well
        interaction: {
          mode: 'nearest',
          intersect: true
        },
        // only listen for mousemove so tooltip appears on hover
        events: ['mousemove', 'mouseout', 'touchstart', 'touchmove']
      },
      plugins: [{
        // center-text plugin unmodified
        id: 'centerText',
        beforeDraw(chart) {
          const { ctx, width, height } = chart;
          ctx.save();
          const fs = Math.floor(Math.min(width, height)/5);
          ctx.font         = `bold ${fs-5}px Arial`;
          ctx.textBaseline = 'middle';
          ctx.fillStyle    = meetsTarget ? '#4a90e2' : '#ff8c00';
          const suffix = /^(accuracy|rescission)$/.test(m.key) ? '%' : '';
          const text   = m.val + suffix;
          const x      = (width - ctx.measureText(text).width)/2;
          const y      = height/2;
          ctx.fillText(text, x, y);
          ctx.restore();
        }
      }]
    });

    // color the metric label below each chart
    labelEl.style.color = meetsTarget ? '#4a90e2' : '#ff8c00';
    
    
    
    
  });
  
  
}

function showComparison() {
  if (compareSelection.size !== 2) {
    return alert("Select exactly 2 employees.");
  }

  const [n1,n2] = [...compareSelection];
  
  document.getElementById("cmp-left").textContent  = n1;
  document.getElementById("cmp-right").textContent = n2;
  
  
  const rows    = scoreboardData[currentMonth] || [];
  const d1      = rows.find(r=>r.name===n1);
  const d2      = rows.find(r=>r.name===n2);

  const labels     = ['Overall','Accuracy %','Rescission %','Transactions','Open Issues'];
  const keys       = ['overall','accuracy','rescission','transactions','issues'];
  const highBetter = new Set(['Overall','Accuracy','Transactions']);

  const container = document.getElementById('compare-rows');
  container.innerHTML = '';

  labels.forEach((lab,i) => {
    const key   = keys[i];
    const v1    = d1[key], v2 = d2[key];
    const t1    = d1[key+'Target']||v1, t2 = d2[key+'Target']||v2;
    const p1Win = v1===v2 || (highBetter.has(lab)? v1>v2 : v1<v2);
    const p2Win = v1===v2 || (highBetter.has(lab)? v2>v1 : v2<v1);
    let pct1, pct2;


if (lab === 'Accuracy %' || lab === 'Rescission %') {
  // pick the right target field (issuesTarget for "issues", otherwise key+"Target")
  let t1 = ((key === 'issues')
             ? d1.issuesTarget
             : d1[key + 'Target']) || 1;
  let t2 = ((key === 'issues')
             ? d2.issuesTarget
             : d2[key + 'Target']) || 1;
  // out of 100
  pct1 = Math.round(v1);
  pct2 = Math.round(v2);
} else if (lab === 'Transactions') {
  // out of each person’s transaction-target
  const t1 = d1.transactionsTarget || 1;
  const t2 = d2.transactionsTarget || 1;
  pct1 = Math.round(v1 / t1 * 100);
  pct2 = Math.round(v2 / t2 * 100);
} else if (lab === 'Overall') {
    // full bar if you met or exceeded your ScoreTarget, otherwise value/target
    pct1 = v1 >= t1 ? 100 : Math.round(v1 / t1 * 100);
    pct2 = v2 >= t2 ? 100 : Math.round(v2 / t2 * 100);

  } else if (lab === 'Open Issues') {
    // **fewer** issues than target → percent; **otherwise** full bar
    pct1 = v1 <  t1 ? Math.round(v1 / t1 * 100) : 100;
    pct2 = v2 <  t2 ? Math.round(v2 / t2 * 100) : 100;
  }

// clamp between 0–100
pct1 = Math.min(100, Math.max(0, pct1));
pct2 = Math.min(100, Math.max(0, pct2));



    // rank calculation
    const sorted = rows.slice().sort((a,b) =>
      highBetter.has(lab) 
        ? b[key] - a[key]
        : a[key] - b[key]
    );
    const r1 = sorted.findIndex(u=>u.name===n1)+1;
    const r2 = sorted.findIndex(u=>u.name===n2)+1;

    // build three-column row
    const row = document.createElement('div');
    
const leftPct  = pct1 + "%";
const rightPct = pct2 + "%";

row.innerHTML = `
  <div class="cmp-cell left ${p1Win ? "winner" : "loser"}">
    <div class="cmp-bar-container">
      <div class="cmp-bar">
        <div class="fill" style="width:${leftPct}"></div>
      </div>
      <div class="cmp-value left">${v1}</div>
    </div>
    <div class="cmp-name">${n1}</div>
    <div class="cmp-rank">#${r1}</div>
  </div>

  <div class="cmp-cell center">${lab}</div>

<div class="cmp-cell right ${p2Win ? "winner" : "loser"}">
  <div class="cmp-bar-container">
    <div class="cmp-bar">
      <div class="fill" style="width:${rightPct}"></div>
    </div>
    <!-- change “left:” to “right:” ↓↓↓ -->
    <div class="cmp-value right">${v2}</div>
  </div>
  <div class="cmp-name">${n2}</div>
  <div class="cmp-rank">#${r2}</div>
</div>
`;


    container.appendChild(row);
  });

  // reset buttons & show panel
  howManyCompareSelected = 0;
  compareSelection.clear();
  document.querySelectorAll('.compare-toggle').forEach(b=>{
    b.textContent='Compare';
    b.classList.remove('remove');
    b.closest('tr').style.opacity='1';
  });
  document.getElementById('compare-container').style.display='block';
  document.getElementById('compare-container')
        .scrollIntoView({ behavior: 'smooth', block: 'start' });
}


// ——— PDF generation ———
function downloadReport() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });
  const pageW = doc.internal.pageSize.getWidth();
  const margin = 40;
  let y = margin;

  // ——— 1) Title + FULL MONTH of YEAR ———
  doc.setFont("Playfair Display","bold").setFontSize(28);
  doc.text(`${siteSelected} at Hilton Grand Vacations`, margin, y);

  // 1) define full month and column names:
const fullMonthNames = {
  Jan:"January",Feb:"February",Mar:"March",
  Apr:"April",May:"May",Jun:"June",
  Jul:"July",Aug:"August",Sep:"September",
  Oct:"October",Nov:"November",Dec:"December"
};
const fullColumnNames = {
  overall:    "Score",
  accuracy:   "Accuracy",
  rescission: "Rescission",
  transactions:"Transactions",
  issues:     "Open Issues"
};

// 2) grab the one you’re sorted on:
const sortedKey      = sortConfig.column;                  // e.g. "transactions"
const sortLabel      = fullColumnNames[sortedKey];         // e.g. "Transactions"
const monthLabel     = fullMonthNames[currentMonth];       // e.g. "MARCH"
const yearLabel      = new Date().getFullYear();           // e.g. 2025

// 3) build two pieces of text, category+month and “ of YEAR”
const leftPart  = `${sortLabel.toUpperCase()}    ||    ${monthLabel}`;
const rightPart = ` of ${yearLabel}`;

// 4) measure & draw them in bold+normal exactly as before
doc.setFont("Montserrat","bold").setFontSize(16);
const wLeft  = doc.getTextWidth(leftPart);
doc.setFont("Montserrat","normal");
const wRight = doc.getTextWidth(rightPart);

const startX = pageW - margin - (wLeft + wRight);

// draw the category+month in bold
doc.setFont("Montserrat","bold")
   .text(leftPart, startX, y);

// draw the “ of YEAR” in normal
doc.setFont("Montserrat","normal")
   .text(rightPart, startX + wLeft, y);

// then advance your y and draw the underline as you already have:
y += 10;
doc.setDrawColor(0);
doc.setLineWidth(0.5);
doc.line(margin, y, pageW - margin, y);

  // ——— 2) Prepare sorted data rows ———
  const raw = (scoreboardData[currentMonth]||[]).slice()
    .sort((a,b)=>
      sortConfig.direction==="asc"
        ? a[sortConfig.column]-b[sortConfig.column]
        : b[sortConfig.column]-a[sortConfig.column]
    );

  const rows = raw.map((r,i)=>[
    `#${i+1}`,        // prefix with #
    r.name,
    r.overall,
    `${r.accuracy}%`,
    `${r.rescission}%`,
    r.transactions,
    r.issues
  ]);

  const headers    = ["Rank","QA Specialist","Score","Accuracy","Rescission","Transactions","Open Issues"];
  const headerKeys = ["rank","name","overall","accuracy","rescission","transactions","issues"];
  const sortedCol  = headerKeys.indexOf(sortConfig.column);

  // ——— 3) Dark, rounded header bar ———
  y += 20;
  const colCount = headers.length;
  const tableX   = margin;
  const tableW   = pageW - margin*2;
  const colW     = tableW / colCount;
  const headerH  = 30;

  doc.setFillColor(30,30,30)
     .roundedRect(tableX, y, tableW, headerH, 6,6,"F");

  headers.forEach((txt,i)=>{
    const isRank = (i===0);
    const isSorted = (i===sortedCol);
    let fontSize = 12;
    if (isSorted) fontSize = 12*1.5;      // 1.5× for sorted
    else if (isRank) fontSize = 14;       // a bit bigger for #
    doc.setFont("Montserrat", isSorted||isRank ? "bold":"normal")
       .setFontSize(fontSize)
       .setTextColor(255)
       .text(
         txt,
         tableX + i*colW + colW/2,
         y + headerH/2 + 5,
         { align:"center" }
       );
  });

  // ——— 4) Body rows w/ custom styling ———
  y += headerH + 4;
  doc.autoTable({
    startY: y,
    body: rows,
    theme: "plain",
    showHead: "never",
    margin: { left: tableX, right: margin },
    styles: {
      font: "Montserrat",
      fontSize: 11,
      textColor: [60,60,60],
      valign: "middle"
    },
    columnStyles: headers.reduce((acc,_,i)=>{
      acc[i] = {
        halign: (i===1 ? "center" : "center"),
        cellWidth: colW
      };
      return acc;
    }, {}),


didParseCell: function(data) {
  if (data.section !== 'body') return;

  const rowIdx   = data.row.index;
  const colIdx   = data.column.index;
  const cell     = data.cell;
  const baseSize = 10.5;
  let   f        = baseSize;

  // highlight top-3
  if (rowIdx < 3) {
    cell.styles.fillColor = [245,245,245];
    f *= 1.2;          // bump top-3 by 20%
  }

  // bump sorted column
  if (colIdx === sortedCol) {
    f *= 1.5;
  }

  cell.styles.fontSize = Math.round(f);

  // bold #1’s rank (col 0), name (col 1) and sorted-cell
  if (rowIdx === 0 && (colIdx === 0 || colIdx === 1 || colIdx === sortedCol)) {
    cell.styles.fontStyle = 'bold';
  }

  // ultra-thin separator
  doc.setDrawColor(200,200,200)
     .setLineWidth(0.2)
     .line(tableX, cell.y + cell.height, tableX + tableW, cell.y + cell.height);
}


  });

  // ——— 5) Save ———
  doc.save(`${siteSelected}-${currentMonth}.pdf`);
}


// ——— NEW: print a single employee ———
function printEmployee(r) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });
  const pageW = doc.internal.pageSize.getWidth();
  const margin = 40;
  let y = margin;

  // ——— Header ———
  doc.setFont("Playfair Display","bold").setFontSize(28);
  y += 10;
  doc.text(`${siteSelected} at Hilton Grand Vacations`, margin, y);
  y += 40;

// 1) Build the two pieces of text
const fullMonthNames = {
  Jan: "JANUARY", Feb: "FEBRUARY", Mar: "MARCH",
  Apr: "APRIL",   May: "MAY",      Jun: "JUNE",
  Jul: "JULY",    Aug: "AUGUST",   Sep: "SEPTEMBER",
  Oct: "OCTOBER", Nov: "NOVEMBER", Dec: "DECEMBER"
};
const monthText = fullMonthNames[currentMonth];
const yearText  = ` of ${new Date().getFullYear()}`;

// 2) Tell jsPDF what font/size you’ll be using _before_ measuring.
doc.setFont("Montserrat","bold");
doc.setFontSize(16);

// 3) Measure both pieces
const wMonth = doc.getTextWidth(monthText);
doc.setFont("Montserrat","normal");
const wYear  = doc.getTextWidth(yearText);

// 4) Compute your starting‐X so that [month+year] ends at (pageW − margin)
const totalW = wMonth + wYear;
const startX = pageW - margin - totalW;

// 5) Finally draw them
//   a) month in bold
doc.setFont("Montserrat","bold");
doc.text(monthText, startX, y);
//   b) year portion in normal
doc.setFont("Montserrat","normal");
doc.text(yearText, startX + wMonth, y);

  y += 5;

  // separator
  doc.setDrawColor(0);
  doc.setLineWidth(0.5);
  doc.line(margin, y, pageW - margin, y);
  y += 45;

  // ——— Employee Name ———
  const leftText = r.name;
  doc.setFont("Montserrat","bold").setFontSize(36);
  doc.text(leftText, pageW/2, y, { align:"center" });


  y += 30;

  // ——— Compute prev-month & current data ———
  const monthIdx  = months.indexOf(currentMonth);
  const prevMonth = months[(monthIdx + 11) % 12];
  const prevData  = (scoreboardData[prevMonth]||[]).find(u=>u.name===r.name) || {};
  const dataThis  = scoreboardData[currentMonth] || [];

  const metricsConfig = [
    { key:"accuracy",     label:"Accuracy",        suffix:"%", better:"high" },
    { key:"transactions", label:"Transactions",    suffix:"",  better:"high" },
    { key:"rescission",   label:"Rescission Rate", suffix:"%", better:"low"  },
    { key:"issues",       label:"Open Issues",     suffix:"",  better:"low"  },
    { key:"overall",      label:"Score",           suffix:"",  better:"high" }
  ];

  const body = metricsConfig.map(cfg => {
    const cur = r[cfg.key];
    // Δ vs last month
    let delta = "-";
    if (prevData[cfg.key] != null) {
      const diff = cur - prevData[cfg.key];
      const sign = diff >= 0 ? "+" : "-";
      const val  = Math.abs(diff).toFixed(
        (cfg.key==="accuracy"||cfg.key==="rescission")?2:0
      );
      delta = cfg.suffix==="%" ? `${sign}${val} %` : `${sign}${val}`;
    }
    // rank
    const sorted = [...dataThis].sort((a,b)=> {
      return cfg.better==="high"
        ? b[cfg.key] - a[cfg.key]
        : a[cfg.key] - b[cfg.key];
    });
    const idx  = sorted.findIndex(u=>u.name===r.name);
    const rank = idx>=0?`${idx+1}/${sorted.length}`:"–";
    return [ cfg.label, `${cur}${cfg.suffix}`, delta, rank ];
  });


// ——— 4) Metrics table ———
  const tableX  = margin;
  const tableW  = pageW - margin * 2;
  const headerH = 30;
  const colCount = 4;
  const colW     = tableW / colCount;

  // 4a) dark rounded header bar
  doc.setFillColor(30,30,30)
     .roundedRect(tableX, y, tableW, headerH, 6, 6, 'F')
     .setFont("Montserrat", "bold").setFontSize(12).setTextColor(255,255,255);
  ["Metric","Value","+/- vs Last Month","Rank"].forEach((txt,i) => {
    doc.text(
      txt,
      tableX + i*colW + colW/2,
      y + headerH/2 + 5,
      { align: "center" }
    );
  });
  y += headerH + 4;

  // 4b) body rows (plain theme, full-width columns)
  doc.autoTable({
    startY: y,
    body: body,
    theme: 'plain',
    showHead: 'never',
    margin: { left: tableX, right: margin },
    styles: {
      font: 'Montserrat',
      fontSize: 11,
      textColor: [60,60,60],
      cellPadding: 6,
      valign: 'middle'
    },
    columnStyles: {
      0: { halign: 'center',   cellWidth: colW },
      1: { halign: 'center', cellWidth: colW },
      2: { halign: 'center', cellWidth: colW },
      3: { halign: 'center', cellWidth: colW }
    },
    didParseCell: function(data) {
      if (data.section === 'body') {
        const row   = data.row.index;
        const cell  = data.cell;
        // alternating gray background
        if (row % 2 === 0) {
          doc.setFillColor(245,245,245)
             .rect(tableX, cell.y, tableW, cell.height, 'F');
        }
        // fine hairline under each row
        doc.setDrawColor(220,220,220)
           .setLineWidth(0.5)
           .line(tableX, cell.y+cell.height, tableX+tableW, cell.y+cell.height);
      }
    }
  });
  y = doc.lastAutoTable.finalY + 30;

  // ——— WRITE-UPS ———
  doc.setFont("Montserrat","bold").setFontSize(14);
  doc.text("WRITE-UPS", margin, y);
  y += 5;

  const labelSize = 10, noteSize = 12, indent = 60;
  const maxWidth  = pageW - margin - (margin + indent);

  ["NTF","Verbal","Written","Final"].forEach(label => {
    const val = r[label] || "";

    // label
    doc.setFont("Montserrat","normal").setFontSize(labelSize).setTextColor(80);
    doc.text(`${label}:`, margin, y);

    // text
    doc.setFont("Montserrat","italic").setFontSize(noteSize).setTextColor(0);
    const lines = doc.splitTextToSize(val, maxWidth);
    lines.forEach((line,i)=>{
      const lineY = y + i*16;
      doc.text(line, margin+indent, lineY);
      doc.setDrawColor(200);
      doc.setLineWidth(0.3);
      doc.line(margin+indent, lineY+2, pageW-margin, lineY+2);
    });
    y += lines.length*16 + 4;
  });
  y += 10;

// ——— PTO / SICK TIME ———
  doc.setFont("Montserrat","bold").setFontSize(14);
  doc.text("PTO / SICK TIME", margin, y);
  y += 18;

  // these two reflect the actual keys you created in parseWorkbook
  const ptFields = [
    { label: "PTO",   val: r.PTO },
    { label: "Sick Time",  val: r["Sick Time"] }
  ];

  ptFields.forEach(({ label, val }) => {
    // label
    doc.setFont("Montserrat","normal")
       .setFontSize(labelSize)
       .setTextColor(80)
       .text(`${label}:`, margin, y);

    // value (italic, wrapping if needed)
    doc.setFont("Montserrat","italic")
       .setFontSize(noteSize)
       .setTextColor(0);

    const lines = doc.splitTextToSize(val, maxWidth);
    lines.forEach((line, i) => {
      const lineY = y + i * 16;
      doc.text(line, margin + indent, lineY);
      doc.setDrawColor(200)
         .setLineWidth(0.3)
         .line(margin + indent, lineY + 2, pageW - margin, lineY + 2);
    });

    // bump y for the next field
    y += lines.length * 16 + 4;
  });

  // ——— SCOREBOARD ———
  y += 30;
  doc.setFont("Montserrat","bold").setFontSize(16);
  doc.text("SCOREBOARD", pageW/2, y, { align:"center" });
  y += 15;

  const ranking = (scoreboardData[currentMonth]||[])
    .slice()
    .sort((a,b)=> b.overall - a.overall);
  const meIndex = ranking.findIndex(u=>u.name===r.name);

  const start = Math.max(0, meIndex-2);
  const end   = Math.min(ranking.length, meIndex+3);
  const lbBody = [];
  if (start>0) lbBody.push(["…","…","…"]);
  for (let i=start;i<end;i++){
    const u = ranking[i];
    lbBody.push([`${i+1}`, u.name, u.overall.toString()]);
  }
  if (end<ranking.length) lbBody.push(["…","…","…"]);

  doc.autoTable({
    startY: y,
    head: [["Rank","Name","Score"]],
    body: lbBody,
    theme: "plain",
    margin: { left: margin, right: margin },
    styles: {
      font: "Montserrat",
      fontSize: 12,
      cellPadding: 6,
      halign: "center",
      valign: "middle",
      textColor: [0,0,0]
    },
    columnStyles: { 1:{ halign:"center" } },
    didParseCell: function(ctx){
      if (ctx.row.raw[1] === r.name) {
        ctx.cell.styles.fillColor = [240,240,240];
        ctx.cell.styles.textColor = [0,0,0];
        ctx.cell.styles.fontSize  = 18;
      } else {
        ctx.cell.styles.fillColor = [255,255,255];
      }
    }
  });

  // ——— Save ———
  doc.save(`${r.name.replace(/\s+/g,"_")}_${currentMonth}.pdf`);
}

window.addEventListener('DOMContentLoaded', () => {
  const closeBtn = document.getElementById('close-compare');
  closeBtn.addEventListener('click', () => {
    // 1) hide the comparison panel
    document.getElementById('compare-container').style.display = 'none';
    // 2) scroll back to the top of the scoreboard container
    window.scrollTo({
      top: document.getElementById('scoreboard-container').offsetTop,
      behavior: 'smooth'
    });
  });
  
  
  
});


const switcher = document.querySelector('.site-switcher');
    const mainBtn  = switcher.querySelector('#site-btn-main');
    const items    = switcher.querySelectorAll('.site-switcher-item');

    // toggle open/closed when you click the active button
    mainBtn.addEventListener('click', e => {
      e.stopPropagation();
      switcher.classList.toggle('open');
    });

    // if you click one of the other two, swap it with the main and collapse
items.forEach(btn => {
  btn.addEventListener('click', e => {
    e.stopPropagation();

    // 1) swap the labels
    const old = mainBtn.textContent.trim();
    const next = btn.textContent.trim();
    mainBtn.textContent = next;
    btn.textContent     = old;

    // 2) toggle “active” classes
    items.forEach(x => x.classList.remove('active'));
    btn.classList.add('active');
    mainBtn.id = 'site-btn-main';
    btn.id     = '';      // old mainBtn loses its ID

    // 3) close the fly-out
    switcher.classList.remove('open');

    // 4) if it’s a new site → clear & re-load
    if (next !== siteSelected) {
      siteSelected = next;
      loadSiteFile(siteSelected);
    }
  });
});


// — 1) load and parse Users.xlsx
async function loadUsers() {
    try {
      const resp = await fetch('Users.xlsx');
      if (!resp.ok) {
        throw new Error(`Network response was not OK (${resp.status})`);
      }
      const ab  = await resp.arrayBuffer();
      const wb  = XLSX.read(ab, { type: 'array' });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const raw = XLSX.utils.sheet_to_json(sheet, { defval: '' });

      return raw.map(r => ({
        username: String(r.Username || '').trim().toLowerCase(),
        password: String(r.Password || '').trim(),
        access: (String(r.Access || '')
                   .split(',')
                   .map(x => x.trim().toLowerCase())
                   .filter(Boolean))
      }));
    } catch (e) {
      console.error('Failed to load or parse Users.xlsx:', e);
      // show a user-friendly error
      const errBox = document.getElementById('login-error');
      if (errBox) {
        errBox.textContent = 'Unable to load user list. Please try again later.';
      }
      // return an empty array so the rest of your code doesn’t blow up
      return [];
    }
  }

  (async function bootstrap() {
    const users = await loadUsers();

document
  .getElementById('login-form')
  .addEventListener('submit', async ev => {
    ev.preventDefault();
    const u   = document.getElementById('login-user').value.trim().toLowerCase();
    const p   = document.getElementById('login-pass').value.trim();
    const err = document.getElementById('login-error');
    err.textContent = '';  // clear old errors

    // after you’ve loaded “users” and read in “u” + “p”:
let isValid = false;

for (const user of users) {
  // Debug‐help: log what you’re comparing



  if (user.username === u && user.password === p) {
    isValid = true;
    break;    // stop as soon as you find a match
  }
}

    if (!isValid) {

      // bad login → show error and stop
      err.textContent = 'Invalid username or password';
      return;
    }

    // good login → tear down overlay
    document.getElementById('scoreboard-container')
            .classList.remove('blurred');
    const ov = document.getElementById('login-overlay');
    ov.style.transition = 'opacity .5s ease';
    ov.style.opacity    = 0;
    ov.addEventListener('transitionend', () => ov.remove());
  });
  })();
    
  </script>
</body>
</html>
